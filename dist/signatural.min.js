var Signatural=function(t){switch(this._options=t||{},this._options.mode=this._options.mode||"mouse",this._options.color=this._options.color||"black",this._canvas=this._options.canvas,this._context=this._canvas.getContext("2d"),this._points=[],this._lastVelocity=0,this._lastWidth=1,this._context.fillStyle=this._options.color,this._mode=this._options.mode,this._penDown=!1,this._mode){case"mouse":this._registerMouseEvents(this);break;case"touch":this._registerTouchEvents(this);break;default:this._registerMouseEvents(this),this._registerTouchEvents(this)}return this.clear(),this};Signatural.VELOCITY_FILTER_WEIGHT=.7,Signatural.prototype.clear=function(){this._context.clearRect(0,0,this._canvas.width,this._canvas.height),this._reset()},Signatural.prototype.toDataURL=function(t,n){return this._canvas.toDataURL(arguments)},Signatural.prototype.fromDataURL=function(t){var n=new Image;n.src=t,this._context.drawImage(n,0,0,this._canvas.width,this._canvas.height)},Signatural.prototype._reset=function(){this._points=[],this._lastVelocity=0,this._lastWidth=1,this._context.fillStyle=this._options.color},Signatural.prototype._registerMouseEvents=function(t){t._canvas.addEventListener("mousedown",function(n){if(1===n.which){t._penDown=!0,t._reset();var i=t._createPoint(n);t._addPoint(i)}}),t._canvas.addEventListener("mousemove",function(n){if(t._penDown){var i=t._createPoint(n);t._addPoint(i)}}),document.addEventListener("mouseup",function(n){if(1===n.which&&t._penDown){t._penDown=!1;var i=t._points.length>2,o=t._points[0],e=t._context;!i&&o&&(e.beginPath(),t._drawPoint(o.x,o.y,2),e.closePath(),e.fill())}})},Signatural.prototype._registerTouchEvents=function(t){t._canvas.addEventListener("touchstart",function(n){t._reset();var i=n.changedTouches[0],o=t._createPoint(i);t._addPoint(o)}),t._canvas.addEventListener("touchmove",function(n){n.preventDefault();var i=n.changedTouches[0],o=t._createPoint(i);t._addPoint(o)}),document.addEventListener("touchend",function(n){var i=n.target===t._canvas,o=t._points.length>2,e=t._points[0],s=t._context;i&&!o&&e&&(s.beginPath(),t._drawPoint(e.x,e.y,2),s.closePath(),s.fill())})},Signatural.prototype._calculateCurveControlPoints=function(t,n,i){var o=t.x-n.x,e=t.y-n.y,s=n.x-i.x,a=n.y-i.y,r={x:(t.x+n.x)/2,y:(t.y+n.y)/2},h={x:(n.x+i.x)/2,y:(n.y+i.y)/2},c=Math.sqrt(o*o+e*e),_=Math.sqrt(s*s+a*a),u=r.x-h.x,l=r.y-h.y,p=_/(c+_),d={x:h.x+u*p,y:h.y+l*p},v=n.x-d.x,y=n.y-d.y;return{c1:new Point(r.x+v,r.y+y),c2:new Point(h.x+v,h.y+y)}},Signatural.prototype._addCurve=function(t){var n,i,o=t.startPoint,e=t.endPoint;n=e.velocityFrom(o),n=Signatural.VELOCITY_FILTER_WEIGHT*n+(1-Signatural.VELOCITY_FILTER_WEIGHT)*this._lastVelocity,i=this._strokeWidth(n),this._drawCurve(t,this._lastWidth,i),this._lastVelocity=n,this._lastWidth=i},Signatural.prototype._drawPoint=function(t,n,i){var o=this._context;o.moveTo(t,n),o.arc(t,n,i,0,2*Math.PI,!1)},Signatural.prototype._drawCurve=function(t,n,i){var o,e,s,a,r,h,c,_,u,l,p,d=this._context,v=i-n;for(o=Math.floor(t.length()),d.beginPath(),s=0;o>s;s++)a=s/o,r=a*a,h=r*a,c=1-a,_=c*c,u=_*c,l=u*t.startPoint.x,l+=3*_*a*t.control1.x,l+=3*c*r*t.control2.x,l+=h*t.endPoint.x,p=u*t.startPoint.y,p+=3*_*a*t.control1.y,p+=3*c*r*t.control2.y,p+=h*t.endPoint.y,e=n+h*v,this._drawPoint(l,p,e);d.closePath(),d.fill()},Signatural.prototype._strokeWidth=function(t){var n=.5,i=2.5;return Math.max(i/(t+1),n)};var Point=function(t,n,i){this.x=t,this.y=n,this.time=i||(new Date).getTime()};Point.prototype.velocityFrom=function(t){return this.distanceTo(t)/(this.time-t.time)},Point.prototype.distanceTo=function(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))},Signatural.prototype._createPoint=function(t){var n=this._canvas.getBoundingClientRect();return new Point(t.clientX-n.left,t.clientY-n.top)},Signatural.prototype._addPoint=function(t){var n,i,o,e,s=this._points;s.push(t),s.length>2&&(3===s.length&&s.unshift(s[0]),e=this._calculateCurveControlPoints(s[0],s[1],s[2]),n=e.c2,e=this._calculateCurveControlPoints(s[1],s[2],s[3]),i=e.c1,o=new Bezier(s[1],n,i,s[2]),this._addCurve(o),s.shift())};var Bezier=function(t,n,i,o){this.startPoint=t,this.control1=n,this.control2=i,this.endPoint=o};Bezier.prototype.length=function(){var t,n,i,o,e,s,a,r,h=10,c=0;for(t=0;h>=t;t++)n=t/h,i=this._point(n,this.startPoint.x,this.control1.x,this.control2.x,this.endPoint.x),o=this._point(n,this.startPoint.y,this.control1.y,this.control2.y,this.endPoint.y),t>0&&(a=i-e,r=o-s,c+=Math.sqrt(a*a+r*r)),e=i,s=o;return c},Bezier.prototype._point=function(t,n,i,o,e){return n*(1-t)*(1-t)*(1-t)+3*i*(1-t)*(1-t)*t+3*o*(1-t)*t*t+e*t*t*t};