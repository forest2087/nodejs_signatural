var Signatural=function(t){switch(this._options=t||{},this._options.mode=this._options.mode||"mouse",this._options.color=this._options.color||"black",this._canvas=this._options.canvas,this._context=this._canvas.getContext("2d"),this._points=[],this._lastVelocity=0,this._lastWidth=1,this._context.fillStyle=this._options.color,this._mode=this._options.mode,this._penDown=!1,this._mode){case"mouse":this._registerMouseEvents(this);break;case"touch":this._registerTouchEvents(this);break;default:this._registerMouseEvents(this),this._registerTouchEvents(this)}return this.clear(),this};Signatural.VELOCITY_FILTER_WEIGHT=.7,Signatural.prototype.clear=function(){this._context.clearRect(0,0,this._canvas.width,this._canvas.height),this._reset()},Signatural.prototype.toDataURL=function(t,i){return this._canvas.toDataURL(arguments)},Signatural.prototype.fromDataURL=function(t){var i=new Image,n=window.devicePixelRatio||1,o=this._canvas.width/n,e=this._canvas.height/n;i.src=t,this._context.drawImage(i,0,0,o,e)},Signatural.prototype._reset=function(){this._points=[],this._lastVelocity=0,this._lastWidth=1,this._context.fillStyle=this._options.color},Signatural.prototype._registerMouseEvents=function(t){t._canvas.addEventListener("mousedown",function(i){if(1===i.which){t._penDown=!0,t._reset();var n=t._createPoint(i);t._addPoint(n)}}),t._canvas.addEventListener("mousemove",function(i){if(t._penDown){var n=t._createPoint(i);t._addPoint(n)}}),document.addEventListener("mouseup",function(i){if(1===i.which&&t._penDown){t._penDown=!1;var n=t._points.length>2,o=t._points[0],e=t._context;!n&&o&&(e.beginPath(),t._drawPoint(o.x,o.y,2),e.closePath(),e.fill())}})},Signatural.prototype._registerTouchEvents=function(t){t._canvas.addEventListener("touchstart",function(i){t._reset();var n=i.changedTouches[0],o=t._createPoint(n);t._addPoint(o)}),t._canvas.addEventListener("touchmove",function(i){i.preventDefault();var n=i.changedTouches[0],o=t._createPoint(n);t._addPoint(o)}),document.addEventListener("touchend",function(i){var n=i.target===t._canvas,o=t._points.length>2,e=t._points[0],s=t._context;n&&!o&&e&&(s.beginPath(),t._drawPoint(e.x,e.y,2),s.closePath(),s.fill())})},Signatural.prototype._calculateCurveControlPoints=function(t,i,n){var o=t.x-i.x,e=t.y-i.y,s=i.x-n.x,a=i.y-n.y,r={x:(t.x+i.x)/2,y:(t.y+i.y)/2},h={x:(i.x+n.x)/2,y:(i.y+n.y)/2},c=Math.sqrt(o*o+e*e),_=Math.sqrt(s*s+a*a),u=r.x-h.x,l=r.y-h.y,d=_/(c+_),p={x:h.x+u*d,y:h.y+l*d},v=i.x-p.x,y=i.y-p.y;return{c1:new Point(r.x+v,r.y+y),c2:new Point(h.x+v,h.y+y)}},Signatural.prototype._addCurve=function(t){var i,n,o=t.startPoint,e=t.endPoint;i=e.velocityFrom(o),i=Signatural.VELOCITY_FILTER_WEIGHT*i+(1-Signatural.VELOCITY_FILTER_WEIGHT)*this._lastVelocity,n=this._strokeWidth(i),this._drawCurve(t,this._lastWidth,n),this._lastVelocity=i,this._lastWidth=n},Signatural.prototype._drawPoint=function(t,i,n){var o=this._context;o.moveTo(t,i),o.arc(t,i,n,0,2*Math.PI,!1)},Signatural.prototype._drawCurve=function(t,i,n){var o,e,s,a,r,h,c,_,u,l,d,p=this._context,v=n-i;for(o=Math.floor(t.length()),p.beginPath(),s=0;o>s;s++)a=s/o,r=a*a,h=r*a,c=1-a,_=c*c,u=_*c,l=u*t.startPoint.x,l+=3*_*a*t.control1.x,l+=3*c*r*t.control2.x,l+=h*t.endPoint.x,d=u*t.startPoint.y,d+=3*_*a*t.control1.y,d+=3*c*r*t.control2.y,d+=h*t.endPoint.y,e=i+h*v,this._drawPoint(l,d,e);p.closePath(),p.fill()},Signatural.prototype._strokeWidth=function(t){var i=.5,n=2.5;return Math.max(n/(t+1),i)};var Point=function(t,i,n){this.x=t,this.y=i,this.time=n||(new Date).getTime()};Point.prototype.velocityFrom=function(t){return this.distanceTo(t)/(this.time-t.time)},Point.prototype.distanceTo=function(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))},Signatural.prototype._createPoint=function(t){var i=this._canvas.getBoundingClientRect();return new Point(t.clientX-i.left,t.clientY-i.top)},Signatural.prototype._addPoint=function(t){var i,n,o,e,s=this._points;s.push(t),s.length>2&&(3===s.length&&s.unshift(s[0]),e=this._calculateCurveControlPoints(s[0],s[1],s[2]),i=e.c2,e=this._calculateCurveControlPoints(s[1],s[2],s[3]),n=e.c1,o=new Bezier(s[1],i,n,s[2]),this._addCurve(o),s.shift())};var Bezier=function(t,i,n,o){this.startPoint=t,this.control1=i,this.control2=n,this.endPoint=o};Bezier.prototype.length=function(){var t,i,n,o,e,s,a,r,h=10,c=0;for(t=0;h>=t;t++)i=t/h,n=this._point(i,this.startPoint.x,this.control1.x,this.control2.x,this.endPoint.x),o=this._point(i,this.startPoint.y,this.control1.y,this.control2.y,this.endPoint.y),t>0&&(a=n-e,r=o-s,c+=Math.sqrt(a*a+r*r)),e=n,s=o;return c},Bezier.prototype._point=function(t,i,n,o,e){return i*(1-t)*(1-t)*(1-t)+3*n*(1-t)*(1-t)*t+3*o*(1-t)*t*t+e*t*t*t};